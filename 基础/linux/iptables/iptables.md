# 简介
## 防火墙的作用
### 做访问控制
- 企业实际工作当中, 建议采购硬件防火墙（思科ASA 华为 H3C）
- 软件防火墙：iptables（centos6） firewalld（centos7）

    - 大并发访问架构：选择硬件防火墙
    - 小并发访问架构：选择软件防火墙

### 总结
1. iptables是基于内核的防火墙，功能非常强大，基于数据包的过滤！特别是可以在一台非常低的硬件配置下跑的非常好。

    >注：iptables主要工作在OSI七层的2.3.4层。七层的控制可以使用squid代理+iptables。
2. iptabes：生产中根据具体情况，一般，内网关闭，外网打开。大并发的情况不能开iptables，影响性能，iptables是要消耗CPU的，所以大并发的情况下，我们使用硬件防火墙。selinux：生产中也是关闭的。可以做ids的入侵检测。
3. 实际生产中尽可能不给服务器配置外网IP。可以通过代理转发。比如，nagios就不需要外网。
4. 并发不是很大的情况下，在外网的IP环境，开防火墙。
5. 第一次直接默认规则生成配置文件，以后就在配置文件中进行修改（编辑添加删除）。
6. 封掉IP：根据IP地址和网络连接数进行封杀。（定时任务，定时封掉，判断，存在就不再进行二次封杀）

## 基础
Ø OSI 7层模型以及不同层对应哪些协议

Ø TCP/IP三次握手，四次断开的过程，TCP HEADER， 状态转换

Ø 常用的服务端口要非常清楚了解

Ø 常用的服务需要原理http协议，ICMP协议。

>参考书籍资料：`tcp/ip协议卷1`

## iptables防火墙介绍
   Netfilter/Iptables(以下简称Iptables)是unix/linux自带的一款优秀且开放源代码的完全自由的基于包过滤的防火墙工具，它的功能十分强大，使用非常灵活，可以对流入和流出服务器的数据包进行很精细的控制。特别是它可以在一台非常低的硬件配置服务器上跑的非常好（赛扬500HZ cpu 64M 内存的惲况下部署网关防火墙），提供近400人的上网服务丝毫不逊色企业级专业路由器防火墙。 iptables + zebra + squid (企业常用网络开源产品）。

>补充：Netfilter一个系统的内核模块，通过netfilter内核控制硬件设备

>Iptables相当于是一个控制软件

>iptables + zebra + squid====一台硬件防火墙（iptables--->防火墙，zebra--->路由器，squid--->缓存）

>iptables是linux2.4及2.6内核中集成的服务，其功能与安全性比其老一蜚ipfwadm，ipchains 强大的多，iptables主要工作在0SI七层的二、三、四层，如果重新编译内核，iptables也可以支持 7 层控制（squid代理+iptables）。

>实现应用层访问控制：Nginx WAF实现访问控制。（属于架构）

# iptables名词和术语
## 容器
容器：包含或者说属于的关系

容器：用来包装或装载物品的贮存器（如箱、罐、坛）或者成形或柔软不成形的包覆材料.

 第一个容器：iptables（包含表）

 第二个容器：表（包含链）

 第三个容器：链（包含规则）

## 表（tables）
 表（tables）是链的容器，即所有的链（chains）都属于其对应的表（tables）.如上，如果把Netfilter看成是某个小区的一栋楼.那么表（tables）就是楼里的其中的一套房子。

## 链（chains）
 链（chains）是规则（Policys）的容器。接上，如果把表（tables）当作有一套房子，那么链（chains）就可以说是房子里的家具（柜子等）。

## 规则（Policy）
 规则（Policy）就比较容易理解了，就是iptables系列过滤信息的规范和具体方法条款了。可以理解为柜子如何增加并摆放柜子东西等。

 # iptables服务表和链的概念
 ## iptables四表五链
 ### filter表
- INPUT
    - 负责过滤所有目标地址是本机地址的数据包

    - 通俗来说：就是过滤进入主机的数据包

    - 对于指定到本地套接字的包，即到达本地防火墙服务器的数据包。

- FORWARD
    - 负责转发流经主机的数据包。起转发的作用，和NAT关系很大，

    - LVS NAT模式，net.ipv4.ip_forword=0

    - 路由穿过的数据包，即经过本地防火墙服务器的数据包。

- OUTPUT
    - 处理所有源地址是本机地址的数据包

    - 通俗的讲：就是处理从主机发出去的数据包

    - 本地创建的数据包

>强调：主要和主机自身相关，真正负责主机防火墙功能的（过滤流入流出主机的数据包）

>filter表示iptables默认使用的表，这个表定义了三个链（chains）

>这是默认表，实现防火墙数据过滤功能。

>企业工作场景：主机防火墙

---

### NAT
- PREROUTING
    - 一进来就对数据包进行改变

    - 在数据包到达防火墙时，进行路由判断之前执行的规则，作用是改变数据包的目的地址、目的端口等

    - 就是收信时，根据规则重写收件人的地址

    > 例如：把公网IP： xxx.xxx.xxx.xxx 映射到局域网的 x.x.x.x 服务器

    > 如果是web服务，可以把80转换为局域网的服务器9000端口上。

- OUTPUT
    - 本地创建的数据包在路由之前进行改变

    - 和主机放出去的数据包有关，改变主机发出数据包的目的地址。

- POSTROUTING
    - 在数据包即将出去时改变数据包信息

    - 在数据包离开防火墙时进行路由判断之后执行的规则，作用改变数据包的源地址，源端口等。

    - 写好收件人的地址，要让家人回信时能够有地址可回。

    >例如。默认笔记本和虚拟机都是局域网地址，在出网的时候被路由器将源地址改为公网地址。

    - 生产应用：局域网共享上网。

>当遇到新创建的数据包连接时将参考这个表

>负责网络地址转换的，即来源与目的的IP地址和port的转换。

>应用：和主机本身无关，一般用于局域网共享上网或者特殊的端口转换相关.

>工作场景：
>
>>1、用于企业路由(zebra)或网关(iptables),共享上网(POSTROUTING)
>>
>>2、做内部外部IP地址一对一映射(dmz),硬件防火墙映射IP到内部服务器，FTP服务(PREROUTING)
>>
>>3、WEB,单个端口的映射，直接映射80端口(PREROUTING)

>这个表定义了3个链，nat功能相当于网络的acl控制。和网络交换机acl类似。

---

### Mangle
- INPUT
    - 进入到设备本身的包

- FORWARD
    - 对路由后的数据包信息进行修改

- PREROUTING
    - 在路由之前更改传入的包

- OUTPUT
    - 本地创建的数据包在路由之前进行改变

- POSTROUTING
    - 在数据包即将离开时更改数据包信息

>这个表专门用于改变数据包

---

### raw
- PREROUTING

    - for packets arriving via any network interface

- OUTPUT

    - for packets  generated by local processes

>此表用处较少，可以忽略不计。

>This  table is used mainly for configuring exemptions from connection tracking in combination with the  NOTRACK  target.

---

## 表链对应关系
![image](/上班\linux\iptables\images\TIM截图20190729223342.png)

## iptables工作流程（规则）
1. 防火墙是层层过滤的，实际是按照配置规则的顺序从上到下，从前到后进行过滤的。

2. 如果匹配上规则，即明确表示是阻止还是通过，数据包就不再向下匹配新的规则。

3. 如果规则中没有明确表明是阻止还是通过的，也就是没有匹配规则，向下进行匹配，直到匹配默认规则得到明确的阻止还是通过。

4. 防火墙的默认规则是所有规则执行完才执行的。

# iptables操作

## ptables参数说明
---
### 显示相关参数

- -n/--numeric

    - 以数字的方式显示地址或端口信息

- -L/ --list

    - 列出一个链或所有链中的规则信息

- --list-rules/-S

    - Print the rules in a chain or all chains

- --line-number

    - 当列出规则信息时，打印规则行号

- -v

    - 显示详细信息，可以叠加

- -h

    - 显示帮助信息
---
### 初始化相关参数

- iptables -F

    - 清除所有规则，不会处理默认的规则

- iptables -X

    - 删除用户自定义的链

- iptables -Z

    - 链的计数器清零（数据包计数器与数据包字节计数器）
---
### 配置常用参数

- -t 表名称

    - 指定配置哪个表，指定配置表名称。

- --append/-A 链名称

    - 附加或追加上相应规则策略，到指定链(链名称必须大写)，默认将配置的规则插入到最后一条。

- --check/-C

    - Check for the existence of a rule

- --insert/-I 链名称

    - 插入相应规则策略，到指定链上，默认将配置的规则插入到第一条（可以根据规则序号插入到指定位置）--封IP地址使用。

- --delete/-D 链名称

    - 删除指定的规则(可以根据规则序号进行删除)

- --replace/-R

    - Replace rule rulenum (1 = first) in chain

- -P(大写)链名称

    - 改变链上的最终默认规则策略

- --new/-N

    - 创建新的用户定义链

- -p 协议名称 , [!] --proto

    - 指定规则的协议名称 all tcp udp icmp

- --dport

    - 指定匹配的目标端口信息

- --sport

    - 指定匹配的源端口信息

- -j 动作

    - 匹配数据包后的动作    

        - ACCEPT 允许
        - DROP 丢弃(没有响应)
        - REJECT 拒绝(回应请求者明确的拒绝)
        - MASQUERADE 伪装上网时使用
        - SNAT 共享地址上网
        - DNAT 目的地址改写

- -i,[!] --in-interface

    - 在INPUT链配置规则中，指定从哪一个网卡接口进入的流量（只能配置在INPUT链上）

- -o,[!] --out-interface

    - 在OUTPUT链配置规则中，指定从哪一个网接口出去的流量（只能配置在OUTPUT链上）

- -s,[!] --source 

    - 指定源IP地址或源网段信息

- -d,[!] --destination

    - 指定目标IP地址或目标网段信息
---
### 扩展参数

- -m 模块

    - 表示增加扩展，匹配功能扩展匹配（可以加载扩展参数）
        - multiport 实现不连续多端口扩展匹配
        - icmp 使用icmp的扩展
        - state 状态模块扩展

- --icmp-type

    - 只有类型8是真正会影响ping，或者也可以采用any；了解很多icmp类型iptables -p icmp -h

- --limit n/{second/minute/hour}

    - 指定时间内的请求速率”n”为速率，后面为时间分别为：秒 分 时

- --limit-burst [n]

    - 在同一时间内允许通过的请求”n”为数字，不指定默认为5

- --exact/-x

    - 扩展数字（显示精确数值）

